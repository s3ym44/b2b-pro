@model B2BProcurement.Controllers.RfqFormViewModel
@{
    var isEdit = Model.Id > 0;
    ViewData["Title"] = isEdit ? "RFQ Düzenle" : "Yeni RFQ Oluştur";
    ViewData["PageTitle"] = isEdit ? "RFQ Düzenle" : "Yeni Teklif Talebi";
    ViewData["Breadcrumb"] = "RFQ";
}

@section Styles {
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" rel="stylesheet" />
<style>
    /* Wizard Container */
    .wizard-container {
        max-width: 950px;
        margin: 0 auto;
    }
    
    /* Progress Steps - 5 Steps */
    .wizard-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        position: relative;
    }
    
    .wizard-progress::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 50px;
        right: 50px;
        height: 3px;
        background: var(--gray-200);
        z-index: 0;
    }
    
    .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
        flex: 1;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--white);
        border: 3px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--gray-400);
        transition: all 0.3s ease;
    }
    
    .wizard-step.active .step-circle {
        border-color: var(--primary);
        background: var(--primary);
        color: var(--white);
    }
    
    .wizard-step.completed .step-circle {
        border-color: var(--success);
        background: var(--success);
        color: var(--white);
    }
    
    .step-title {
        margin-top: 10px;
        font-size: 12px;
        font-weight: 500;
        color: var(--gray-500);
        text-align: center;
    }
    
    .wizard-step.active .step-title {
        color: var(--primary);
        font-weight: 600;
    }
    
    .wizard-step.completed .step-title {
        color: var(--success);
    }
    
    /* Form Card */
    .wizard-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }
    
    .wizard-card-header {
        padding: 24px 32px;
        background: linear-gradient(135deg, var(--primary), #8B5CF6);
        color: var(--white);
    }
    
    .wizard-card-header h4 {
        margin: 0;
        font-weight: 600;
    }
    
    .wizard-card-header p {
        margin: 8px 0 0;
        opacity: 0.8;
        font-size: 14px;
    }
    
    .wizard-card-body {
        padding: 32px;
    }
    
    .wizard-card-footer {
        padding: 20px 32px;
        background: var(--gray-50);
        border-top: 1px solid var(--gray-100);
        display: flex;
        justify-content: space-between;
    }
    
    /* Step Content */
    .wizard-step-content {
        display: none;
    }
    
    .wizard-step-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form Fields */
    .form-section {
        margin-bottom: 24px;
    }
    
    .form-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--gray-100);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-label {
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 6px;
        font-size: 14px;
    }
    
    .form-label .required {
        color: var(--danger);
        margin-left: 2px;
    }
    
    .form-control, .form-select {
        border-radius: var(--radius-md);
        border-color: var(--gray-200);
        padding: 12px 16px;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(123, 47, 247, 0.1);
    }
    
    textarea.form-control {
        min-height: 80px;
        resize: vertical;
    }
    
    /* Option Cards */
    .option-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .option-card {
        position: relative;
    }
    
    .option-card input {
        position: absolute;
        opacity: 0;
    }
    
    .option-card label {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .option-card label:hover {
        border-color: var(--primary);
    }
    
    .option-card input:checked + label {
        border-color: var(--primary);
        background: rgba(123, 47, 247, 0.05);
    }
    
    .option-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        background: var(--gray-100);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: var(--gray-600);
    }
    
    .option-card input:checked + label .option-icon {
        background: var(--primary);
        color: var(--white);
    }
    
    .option-info h6 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
    }
    
    .option-info p {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--gray-500);
    }
    
    /* Date Range */
    .date-range {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .date-range .date-field {
        flex: 1;
    }
    
    .date-range .separator {
        color: var(--gray-400);
        font-weight: 500;
    }
    
    /* Items/Contacts Table */
    .data-table-wrapper {
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .data-table {
        width: 100%;
        margin: 0;
    }
    
    .data-table th {
        background: var(--gray-50);
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 600;
        color: var(--gray-600);
        text-transform: uppercase;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .data-table td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: middle;
        font-size: 14px;
    }
    
    .data-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .data-table tbody tr:hover {
        background: var(--gray-50);
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray-500);
    }
    
    /* Add Panel */
    .add-panel {
        background: var(--gray-50);
        border: 1px dashed var(--gray-300);
        border-radius: var(--radius-md);
        padding: 24px;
        margin-bottom: 24px;
    }
    
    /* Dropzone */
    .dropzone-container {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-md);
        padding: 40px 20px;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .dropzone-container:hover {
        border-color: var(--primary);
    }
    
    .dropzone-icon {
        font-size: 48px;
        color: var(--gray-400);
        margin-bottom: 16px;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
    }
    
    .file-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        background: var(--gray-100);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-600);
    }
    
    .file-info {
        flex: 1;
    }
    
    .file-name {
        font-weight: 500;
        color: var(--gray-800);
        font-size: 14px;
    }
    
    .file-size {
        font-size: 12px;
        color: var(--gray-500);
    }
    
    /* Contact Card */
    .contact-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .contact-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), #8B5CF6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 18px;
    }
    
    .contact-info {
        flex: 1;
    }
    
    .contact-name {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 2px;
    }
    
    .contact-detail {
        font-size: 13px;
        color: var(--gray-500);
    }
    
    /* Preview Section */
    .preview-section {
        margin-bottom: 24px;
    }
    
    .preview-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .preview-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    
    .preview-item {
        background: var(--gray-50);
        padding: 12px 16px;
        border-radius: var(--radius-md);
    }
    
    .preview-label {
        font-size: 11px;
        color: var(--gray-500);
        text-transform: uppercase;
        margin-bottom: 4px;
    }
    
    .preview-value {
        font-weight: 600;
        color: var(--gray-800);
    }
    
    /* Buttons */
    .btn-wizard {
        padding: 12px 28px;
        font-weight: 500;
        border-radius: var(--radius-md);
    }
    
    .btn-next {
        background: var(--primary);
        color: var(--white);
        border: none;
    }
    
    .btn-next:hover {
        background: #6B21A8;
        color: var(--white);
    }
    
    .btn-prev {
        background: var(--white);
        color: var(--gray-600);
        border: 1px solid var(--gray-200);
    }
    
    .btn-prev:hover {
        background: var(--gray-50);
        color: var(--gray-800);
    }
    
    .action-buttons {
        display: flex;
        gap: 12px;
    }
    
    .btn-draft {
        background: var(--gray-600);
        color: var(--white);
        border: none;
    }
    
    .btn-draft:hover {
        background: var(--gray-700);
        color: var(--white);
    }
    
    .btn-publish {
        background: var(--success);
        color: var(--white);
        border: none;
    }
    
    .btn-publish:hover {
        background: #059669;
        color: var(--white);
    }
    
    /* Select2 Custom */
    .select2-container--bootstrap-5 .select2-selection {
        padding: 8px 12px;
        min-height: 46px;
    }
</style>
}

<div class="wizard-container">
    <!-- Progress Steps - 5 Steps -->
    <div class="wizard-progress">
        <div class="wizard-step active" data-step="1">
            <div class="step-circle">1</div>
            <span class="step-title">Temel Bilgiler</span>
        </div>
        <div class="wizard-step" data-step="2">
            <div class="step-circle">2</div>
            <span class="step-title">Kalemler</span>
        </div>
        <div class="wizard-step" data-step="3">
            <div class="step-circle">3</div>
            <span class="step-title">Dokümanlar</span>
        </div>
        <div class="wizard-step" data-step="4">
            <div class="step-circle">4</div>
            <span class="step-title">Muhataplar</span>
        </div>
        <div class="wizard-step" data-step="5">
            <div class="step-circle">5</div>
            <span class="step-title">Önizleme</span>
        </div>
    </div>
    
    <!-- Wizard Card -->
    <div class="wizard-card">
        <form asp-action="Create" method="post" id="rfqWizardForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <input type="hidden" name="ItemsJson" id="itemsJsonInput" />
            <input type="hidden" name="ContactsJson" id="contactsJsonInput" />
            <input type="hidden" name="Action" id="formAction" value="draft" />
            
            <!-- ========== STEP 1: Temel Bilgiler ========== -->
            <div class="wizard-step-content active" id="step1">
                <div class="wizard-card-header">
                    <h4><i class="fas fa-info-circle me-2"></i>Temel Bilgiler</h4>
                    <p>RFQ'nun genel bilgilerini girin</p>
                </div>
                <div class="wizard-card-body">
                    <div class="form-section">
                        <label asp-for="Title" class="form-label">RFQ Başlığı <span class="required">*</span></label>
                        <input asp-for="Title" class="form-control" placeholder="Örn: 2026 Yılı Ofis Malzemeleri Alımı" />
                        <span asp-validation-for="Title" class="text-danger small"></span>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-tag"></i>Teklif Tipi</div>
                        <div class="option-cards">
                            <div class="option-card">
                                <input type="radio" name="RfqType" id="typeNormal" value="Normal" checked />
                                <label for="typeNormal">
                                    <div class="option-icon"><i class="fas fa-file-alt"></i></div>
                                    <div class="option-info"><h6>Normal Teklif</h6><p>Standart teklif talebi</p></div>
                                </label>
                            </div>
                            <div class="option-card">
                                <input type="radio" name="RfqType" id="typeTender" value="Tender" />
                                <label for="typeTender">
                                    <div class="option-icon"><i class="fas fa-gavel"></i></div>
                                    <div class="option-info"><h6>İhale</h6><p>Rekabetçi ihale süreci</p></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-section">
                                <label asp-for="SectorId" class="form-label">Sektör <span class="required">*</span></label>
                                <select asp-for="SectorId" class="form-select" asp-items="@ViewBag.Sectors">
                                    <option value="">Sektör seçin...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-section">
                                <label asp-for="Visibility" class="form-label">Görünürlük</label>
                                <select asp-for="Visibility" class="form-select" asp-items="@ViewBag.Visibilities"></select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-calendar-alt"></i>Teklif Süresi</div>
                        <div class="date-range">
                            <div class="date-field">
                                <label asp-for="StartDate" class="form-label">Başlangıç <span class="required">*</span></label>
                                <input asp-for="StartDate" type="date" class="form-control" />
                            </div>
                            <span class="separator mt-4">—</span>
                            <div class="date-field">
                                <label asp-for="EndDate" class="form-label">Bitiş <span class="required">*</span></label>
                                <input asp-for="EndDate" type="date" class="form-control" />
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="form-section">
                                <label asp-for="Currency" class="form-label">Para Birimi</label>
                                <select asp-for="Currency" class="form-select" asp-items="@ViewBag.Currencies"></select>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-section">
                                <label class="form-label">Açıklama</label>
                                <textarea name="Description" id="rfqDescription" class="form-control" rows="2" placeholder="RFQ hakkında ek bilgiler..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="wizard-card-footer">
                    <a href="@Url.Action("Index")" class="btn btn-wizard btn-prev"><i class="fas fa-times me-2"></i>İptal</a>
                    <button type="button" class="btn btn-wizard btn-next" onclick="nextStep(1)">Devam <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
            
            <!-- ========== STEP 2: Kalemler ========== -->
            <div class="wizard-step-content" id="step2">
                <div class="wizard-card-header" style="background: linear-gradient(135deg, #0EA5E9, #06B6D4);">
                    <h4><i class="fas fa-list-ul me-2"></i>Talep Kalemleri</h4>
                    <p>Talep ettiğiniz malzeme veya hizmetleri ekleyin</p>
                </div>
                <div class="wizard-card-body">
                    <div class="add-panel">
                        <div class="form-section-title"><i class="fas fa-plus-circle"></i>Yeni Kalem Ekle</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Malzeme</label>
                                <select id="materialSelect" class="form-select">
                                    <option value="">Manuel giriş veya malzeme seçin...</option>
                                    @foreach (var mat in (dynamic)ViewBag.Materials)
                                    {
                                        <option value="@mat.Id" data-name="@mat.Name" data-unit="@mat.Unit">@mat.Code - @mat.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Açıklama <span class="required">*</span></label>
                                <input type="text" id="itemDescription" class="form-control" placeholder="Malzeme/hizmet açıklaması" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Miktar <span class="required">*</span></label>
                                <input type="number" id="itemQuantity" class="form-control" step="0.01" min="0.01" placeholder="0.00" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Birim <span class="required">*</span></label>
                                <input type="text" id="itemUnit" class="form-control" placeholder="Adet, Kg..." />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">İstenen Teslim</label>
                                <input type="date" id="itemDeliveryDate" class="form-control" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Notlar</label>
                                <input type="text" id="itemNotes" class="form-control" placeholder="Opsiyonel" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Teknik Özellikler</label>
                                <textarea id="itemSpecs" class="form-control" rows="2" placeholder="Teknik detaylar..."></textarea>
                            </div>
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-success" onclick="addItem()"><i class="fas fa-plus me-2"></i>Kalemi Ekle</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead><tr><th>#</th><th>Açıklama</th><th>Miktar</th><th>Birim</th><th>Teslim</th><th style="width:70px;">İşlem</th></tr></thead>
                            <tbody id="itemsTableBody">
                                <tr id="emptyItemsRow"><td colspan="6" class="empty-state"><i class="fas fa-inbox mb-2" style="font-size:28px;"></i><p class="mb-0">Henüz kalem eklenmedi</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="wizard-card-footer">
                    <button type="button" class="btn btn-wizard btn-prev" onclick="prevStep(2)"><i class="fas fa-arrow-left me-2"></i>Geri</button>
                    <button type="button" class="btn btn-wizard btn-next" onclick="nextStep(2)">Devam <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
            
            <!-- ========== STEP 3: Dokümanlar ========== -->
            <div class="wizard-step-content" id="step3">
                <div class="wizard-card-header" style="background: linear-gradient(135deg, #10B981, #059669);">
                    <h4><i class="fas fa-file-upload me-2"></i>Dokümanlar</h4>
                    <p>RFQ'ya ilgili dokümanları ekleyin (opsiyonel)</p>
                </div>
                <div class="wizard-card-body">
                    <div class="form-section">
                        <label class="form-label">Doküman Tipi</label>
                        <select id="documentType" class="form-select" style="max-width: 300px;">
                            <option value="TechnicalSpec">Teknik Şartname</option>
                            <option value="Drawing">Çizim / Proje</option>
                            <option value="Image">Görsel</option>
                            <option value="Other">Diğer</option>
                        </select>
                    </div>
                    
                    <div class="form-section">
                        <div class="dropzone-container" id="documentDropzone">
                            <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
                            <h5>Dosyaları Sürükleyin veya Tıklayın</h5>
                            <p class="text-muted mb-0">PDF, Word, Excel, Görsel (Max: 10MB)</p>
                        </div>
                    </div>
                    
                    <div id="uploadedFilesList"></div>
                </div>
                <div class="wizard-card-footer">
                    <button type="button" class="btn btn-wizard btn-prev" onclick="prevStep(3)"><i class="fas fa-arrow-left me-2"></i>Geri</button>
                    <button type="button" class="btn btn-wizard btn-next" onclick="nextStep(3)">Devam <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
            
            <!-- ========== STEP 4: Muhataplar ========== -->
            <div class="wizard-step-content" id="step4">
                <div class="wizard-card-header" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                    <h4><i class="fas fa-user-friends me-2"></i>İlgili Kişiler</h4>
                    <p>RFQ için iletişim kurulacak kişileri ekleyin</p>
                </div>
                <div class="wizard-card-body">
                    <div class="add-panel">
                        <div class="form-section-title"><i class="fas fa-user-plus"></i>Muhatap Ekle</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Ad Soyad <span class="required">*</span></label>
                                <input type="text" id="contactName" class="form-control" placeholder="İlgili kişi adı" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">E-posta <span class="required">*</span></label>
                                <input type="email" id="contactEmail" class="form-control" placeholder="email@firma.com" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Telefon</label>
                                <input type="tel" id="contactPhone" class="form-control" placeholder="+90 5XX XXX XX XX" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Departman</label>
                                <input type="text" id="contactDepartment" class="form-control" placeholder="Satın Alma, Teknik vb." />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Unvan</label>
                                <input type="text" id="contactTitle" class="form-control" placeholder="Müdür, Uzman vb." />
                            </div>
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-success" onclick="addContact()"><i class="fas fa-plus me-2"></i>Muhatap Ekle</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="contactsList">
                        <div id="emptyContactsState" class="empty-state">
                            <i class="fas fa-users mb-2" style="font-size: 28px;"></i>
                            <p class="mb-0">Henüz muhatap eklenmedi</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>İpucu:</strong> Muhatap eklemeniz opsiyoneldir. Eklemezseniz şirket bilgileriniz kullanılır.
                    </div>
                </div>
                <div class="wizard-card-footer">
                    <button type="button" class="btn btn-wizard btn-prev" onclick="prevStep(4)"><i class="fas fa-arrow-left me-2"></i>Geri</button>
                    <button type="button" class="btn btn-wizard btn-next" onclick="nextStep(4)">Devam <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
            
            <!-- ========== STEP 5: Önizleme ve Gönder ========== -->
            <div class="wizard-step-content" id="step5">
                <div class="wizard-card-header" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                    <h4><i class="fas fa-eye me-2"></i>Önizleme ve Gönder</h4>
                    <p>Bilgileri kontrol edin ve RFQ'yu kaydedin veya yayınlayın</p>
                </div>
                <div class="wizard-card-body">
                    <div id="previewContent"></div>
                </div>
                <div class="wizard-card-footer">
                    <button type="button" class="btn btn-wizard btn-prev" onclick="prevStep(5)"><i class="fas fa-arrow-left me-2"></i>Geri</button>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-wizard btn-draft" onclick="submitForm('draft')">
                            <i class="fas fa-save me-2"></i>Taslak Kaydet
                        </button>
                        <button type="button" class="btn btn-wizard btn-publish" onclick="submitForm('publish')">
                            <i class="fas fa-paper-plane me-2"></i>Yayınla
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script>
    // ===== WIZARD =====
    let currentStep = 1;
    const totalSteps = 5;
    
    function updateProgress() {
        document.querySelectorAll('.wizard-step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            if (stepNum < currentStep) step.classList.add('completed');
            else if (stepNum === currentStep) step.classList.add('active');
        });
        document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
            content.classList.toggle('active', index + 1 === currentStep);
        });
    }
    
    function validateStep(step) {
        if (step === 1) {
            const title = $('#Title').val().trim();
            const sector = $('#SectorId').val();
            const startDate = $('#StartDate').val();
            const endDate = $('#EndDate').val();
            if (!title) { alert('Lütfen RFQ başlığını girin.'); return false; }
            if (!sector) { alert('Lütfen sektör seçin.'); return false; }
            if (!startDate || !endDate) { alert('Lütfen tarih aralığını belirleyin.'); return false; }
            if (new Date(endDate) <= new Date(startDate)) { alert('Bitiş tarihi başlangıç tarihinden sonra olmalıdır.'); return false; }
        }
        if (step === 2 && items.length === 0) { alert('Lütfen en az bir kalem ekleyin.'); return false; }
        return true;
    }
    
    function nextStep(step) {
        if (!validateStep(step)) return;
        if (currentStep < totalSteps) {
            currentStep++;
            updateProgress();
            if (currentStep === 5) generatePreview();
        }
    }
    
    function prevStep(step) {
        if (currentStep > 1) { currentStep--; updateProgress(); }
    }
    
    // ===== ITEMS =====
    let items = [];
    let itemCounter = 0;
    
    $(document).ready(function() {
        $('#materialSelect').select2({ theme: 'bootstrap-5', placeholder: 'Malzeme arayın...', allowClear: true });
        $('#materialSelect').on('change', function() {
            const opt = $(this).find(':selected');
            if (opt.val()) {
                $('#itemDescription').val(opt.data('name') || '');
                $('#itemUnit').val(opt.data('unit') || 'Adet');
            }
        });
        
        const today = new Date().toISOString().split('T')[0];
        const end = new Date(); end.setDate(end.getDate() + 14);
        if (!$('#StartDate').val()) $('#StartDate').val(today);
        if (!$('#EndDate').val()) $('#EndDate').val(end.toISOString().split('T')[0]);
    });
    
    function addItem() {
        const materialId = $('#materialSelect').val() || null;
        const description = $('#itemDescription').val().trim();
        const quantity = parseFloat($('#itemQuantity').val());
        const unit = $('#itemUnit').val().trim();
        const deliveryDate = $('#itemDeliveryDate').val();
        const notes = $('#itemNotes').val().trim();
        const specs = $('#itemSpecs').val().trim();
        
        if (!description) { alert('Açıklama zorunludur.'); return; }
        if (!quantity || quantity <= 0) { alert('Geçerli miktar girin.'); return; }
        if (!unit) { alert('Birim zorunludur.'); return; }
        
        items.push({ id: ++itemCounter, materialId: materialId ? parseInt(materialId) : null, description, quantity, unit, deliveryDate: deliveryDate || null, notes: notes || null, technicalSpecs: specs || null });
        renderItems();
        clearItemForm();
    }
    
    function removeItem(id) { items = items.filter(i => i.id !== id); renderItems(); }
    
    function renderItems() {
        const tbody = $('#itemsTableBody');
        tbody.empty();
        if (items.length === 0) {
            tbody.html('<tr id="emptyItemsRow"><td colspan="6" class="empty-state"><i class="fas fa-inbox mb-2" style="font-size:28px;"></i><p class="mb-0">Henüz kalem eklenmedi</p></td></tr>');
            return;
        }
        items.forEach((item, i) => {
            tbody.append(`<tr><td>${i+1}</td><td><strong>${item.description}</strong></td><td>${item.quantity.toFixed(2)}</td><td>${item.unit}</td><td>${item.deliveryDate || '-'}</td><td><button type="button" class="btn btn-sm btn-light text-danger" onclick="removeItem(${item.id})"><i class="fas fa-trash"></i></button></td></tr>`);
        });
        $('#itemsJsonInput').val(JSON.stringify(items));
    }
    
    function clearItemForm() {
        $('#materialSelect').val('').trigger('change');
        $('#itemDescription, #itemQuantity, #itemUnit, #itemDeliveryDate, #itemNotes, #itemSpecs').val('');
    }
    
    // ===== CONTACTS =====
    let contacts = [];
    let contactCounter = 0;
    
    function addContact() {
        const name = $('#contactName').val().trim();
        const email = $('#contactEmail').val().trim();
        const phone = $('#contactPhone').val().trim();
        const department = $('#contactDepartment').val().trim();
        const title = $('#contactTitle').val().trim();
        
        if (!name) { alert('Ad Soyad zorunludur.'); return; }
        if (!email || email.indexOf('@@') === -1) { alert('Geçerli e-posta girin.'); return; }
        
        contacts.push({ id: ++contactCounter, name, email, phone: phone || null, department: department || null, title: title || null });
        renderContacts();
        clearContactForm();
    }
    
    function removeContact(id) { contacts = contacts.filter(c => c.id !== id); renderContacts(); }
    
    function renderContacts() {
        const container = $('#contactsList');
        container.empty();
        if (contacts.length === 0) {
            container.html('<div id="emptyContactsState" class="empty-state"><i class="fas fa-users mb-2" style="font-size:28px;"></i><p class="mb-0">Henüz muhatap eklenmedi</p></div>');
            return;
        }
        contacts.forEach(c => {
            const initials = c.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            container.append(`
                <div class="contact-card">
                    <div class="contact-avatar">${initials}</div>
                    <div class="contact-info">
                        <div class="contact-name">${c.name} ${c.title ? '<span class="text-muted">- ' + c.title + '</span>' : ''}</div>
                        <div class="contact-detail"><i class="fas fa-envelope me-1"></i>${c.email} ${c.phone ? '&nbsp;|&nbsp;<i class="fas fa-phone me-1"></i>' + c.phone : ''}</div>
                        ${c.department ? '<div class="contact-detail"><i class="fas fa-building me-1"></i>' + c.department + '</div>' : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-light text-danger" onclick="removeContact(${c.id})"><i class="fas fa-times"></i></button>
                </div>
            `);
        });
        $('#contactsJsonInput').val(JSON.stringify(contacts));
    }
    
    function clearContactForm() {
        $('#contactName, #contactEmail, #contactPhone, #contactDepartment, #contactTitle').val('');
    }
    
    // ===== DROPZONE =====
    Dropzone.autoDiscover = false;
    let uploadedFiles = [];
    
    $(document).ready(function() {
        new Dropzone("#documentDropzone", {
            url: "/Rfq/UploadTemp",
            autoProcessQueue: false,
            addRemoveLinks: true,
            maxFilesize: 10,
            acceptedFiles: ".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png",
            dictDefaultMessage: "",
            init: function() {
                this.on("addedfile", file => { uploadedFiles.push(file); renderFiles(); });
                this.on("removedfile", file => { uploadedFiles = uploadedFiles.filter(f => f !== file); renderFiles(); });
            }
        });
    });
    
    function renderFiles() {
        const container = $('#uploadedFilesList');
        container.empty();
        uploadedFiles.forEach((file, i) => {
            const size = (file.size / 1024).toFixed(1) + ' KB';
            const icon = getFileIcon(file.name);
            container.append(`<div class="file-item"><div class="file-icon"><i class="${icon}"></i></div><div class="file-info"><div class="file-name">${file.name}</div><div class="file-size">${size}</div></div></div>`);
        });
    }
    
    function getFileIcon(name) {
        const ext = name.split('.').pop().toLowerCase();
        if (ext === 'pdf') return 'fas fa-file-pdf';
        if (['doc','docx'].includes(ext)) return 'fas fa-file-word';
        if (['xls','xlsx'].includes(ext)) return 'fas fa-file-excel';
        if (['jpg','jpeg','png'].includes(ext)) return 'fas fa-file-image';
        return 'fas fa-file';
    }
    
    // ===== PREVIEW =====
    function generatePreview() {
        const title = $('#Title').val();
        const sectorText = $('#SectorId option:selected').text();
        const visibilityText = $('#Visibility option:selected').text();
        const startDate = $('#StartDate').val();
        const endDate = $('#EndDate').val();
        const currencyText = $('#Currency option:selected').text();
        const rfqType = $('input[name="RfqType"]:checked').val() === 'Tender' ? 'İhale' : 'Normal Teklif';
        const description = $('#rfqDescription').val();
        
        let itemsHtml = items.length > 0 ? '<div class="data-table-wrapper"><table class="data-table"><thead><tr><th>#</th><th>Açıklama</th><th>Miktar</th><th>Birim</th></tr></thead><tbody>' + items.map((item, i) => `<tr><td>${i+1}</td><td>${item.description}</td><td>${item.quantity}</td><td>${item.unit}</td></tr>`).join('') + '</tbody></table></div>' : '<p class="text-muted">Kalem eklenmedi</p>';
        
        let contactsHtml = contacts.length > 0 ? contacts.map(c => `<div class="contact-card"><div class="contact-avatar">${c.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase()}</div><div class="contact-info"><div class="contact-name">${c.name}</div><div class="contact-detail">${c.email}</div></div></div>`).join('') : '<p class="text-muted">Muhatap eklenmedi (Şirket bilgileri kullanılacak)</p>';
        
        $('#previewContent').html(`
            <div class="preview-section">
                <div class="preview-section-title"><i class="fas fa-info-circle"></i>Temel Bilgiler</div>
                <div class="preview-grid">
                    <div class="preview-item"><div class="preview-label">Başlık</div><div class="preview-value">${title}</div></div>
                    <div class="preview-item"><div class="preview-label">Teklif Tipi</div><div class="preview-value">${rfqType}</div></div>
                    <div class="preview-item"><div class="preview-label">Sektör</div><div class="preview-value">${sectorText}</div></div>
                    <div class="preview-item"><div class="preview-label">Görünürlük</div><div class="preview-value">${visibilityText}</div></div>
                    <div class="preview-item"><div class="preview-label">Süre</div><div class="preview-value">${startDate} — ${endDate}</div></div>
                    <div class="preview-item"><div class="preview-label">Para Birimi</div><div class="preview-value">${currencyText}</div></div>
                </div>
                ${description ? '<div class="mt-3"><strong>Açıklama:</strong> ' + description + '</div>' : ''}
            </div>
            <div class="preview-section">
                <div class="preview-section-title"><i class="fas fa-list-ul"></i>Kalemler (${items.length})</div>
                ${itemsHtml}
            </div>
            <div class="preview-section">
                <div class="preview-section-title"><i class="fas fa-file"></i>Dokümanlar (${uploadedFiles.length})</div>
                <p class="text-muted">${uploadedFiles.length > 0 ? uploadedFiles.map(f => f.name).join(', ') : 'Doküman yüklenmedi'}</p>
            </div>
            <div class="preview-section">
                <div class="preview-section-title"><i class="fas fa-user-friends"></i>Muhataplar (${contacts.length})</div>
                ${contactsHtml}
            </div>
            <div class="alert alert-warning mb-0 mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Uyarı:</strong> "Yayınla" seçeneği ile RFQ hemen aktif hale gelir ve tedarikçilere görünür olur.
            </div>
        `);
    }
    
    // ===== SUBMIT =====
    function submitForm(action) {
        if (action === 'publish' && !confirm('RFQ yayınlandığında tedarikçilere görünür olacak. Devam etmek istiyor musunuz?')) return;
        
        $('#formAction').val(action);
        $('#itemsJsonInput').val(JSON.stringify(items));
        $('#contactsJsonInput').val(JSON.stringify(contacts));
        $('#rfqWizardForm').submit();
    }
</script>
}
