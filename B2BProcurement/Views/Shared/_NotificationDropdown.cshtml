@* Notification Dropdown Partial View - Header'a eklenecek *@

<div class="notification-dropdown dropdown">
    <button class="btn btn-link position-relative p-2" type="button" id="notificationDropdown" 
            data-bs-toggle="dropdown" aria-expanded="false" onclick="loadNotifications()">
        <i class="fas fa-bell fa-lg text-muted"></i>
        <span class="notification-badge d-none" id="notificationBadge">0</span>
    </button>
    
    <div class="dropdown-menu dropdown-menu-end notification-menu" aria-labelledby="notificationDropdown">
        <div class="notification-header">
            <h6 class="mb-0">Bildirimler</h6>
            <button class="btn btn-sm btn-link p-0" onclick="markAllAsRead()" id="markAllBtn">
                Tümünü Okundu İşaretle
            </button>
        </div>
        
        <div class="notification-list" id="notificationList">
            <div class="notification-loading">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2">Yükleniyor...</span>
            </div>
        </div>
        
        <div class="notification-footer">
            <a href="/Notification/All" class="text-primary">Tüm Bildirimleri Gör</a>
        </div>
    </div>
</div>

<style>
.notification-dropdown .btn-link {
    color: var(--gray-600);
    text-decoration: none;
}

.notification-dropdown .btn-link:hover {
    color: var(--primary);
}

.notification-badge {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    font-size: 11px;
    font-weight: 600;
    line-height: 18px;
    text-align: center;
    background: #EF4444;
    color: white;
    border-radius: 9px;
}

.notification-menu {
    width: 360px;
    padding: 0;
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    border-radius: 12px;
    overflow: hidden;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
}

.notification-header h6 {
    font-weight: 600;
    color: var(--gray-800);
}

.notification-list {
    max-height: 400px;
    overflow-y: auto;
}

.notification-loading,
.notification-empty {
    padding: 40px 20px;
    text-align: center;
    color: var(--gray-500);
}

.notification-item {
    display: flex;
    gap: 12px;
    padding: 14px 20px;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    transition: background 0.2s;
}

.notification-item:hover {
    background: var(--gray-50);
}

.notification-item.unread {
    background: #EFF6FF;
}

.notification-item.unread:hover {
    background: #DBEAFE;
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.notification-icon.info { background: #DBEAFE; color: #2563EB; }
.notification-icon.success { background: #DCFCE7; color: #16A34A; }
.notification-icon.warning { background: #FEF3C7; color: #D97706; }
.notification-icon.error { background: #FEE2E2; color: #DC2626; }
.notification-icon.newrfq { background: #EDE9FE; color: #7C3AED; }
.notification-icon.newquotation { background: #DBEAFE; color: #2563EB; }
.notification-icon.quotationapproved { background: #DCFCE7; color: #16A34A; }
.notification-icon.quotationrejected { background: #FEE2E2; color: #DC2626; }
.notification-icon.rfqexpiring { background: #FEF3C7; color: #D97706; }

.notification-content {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--gray-800);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.notification-message {
    font-size: 13px;
    color: var(--gray-600);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.notification-time {
    font-size: 11px;
    color: var(--gray-400);
    margin-top: 4px;
}

.notification-footer {
    padding: 12px 20px;
    text-align: center;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
}

.notification-footer a {
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
}
</style>

<script>
// Notification functions
let notificationLoaded = false;

async function loadNotifications() {
    if (notificationLoaded) return;
    
    try {
        const response = await fetch('/api/Notification/unread');
        const data = await response.json();
        
        if (data.success) {
            updateNotificationBadge(data.count);
            renderNotifications(data.notifications);
            notificationLoaded = true;
        }
    } catch (error) {
        console.error('Failed to load notifications:', error);
    }
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.classList.remove('d-none');
    } else {
        badge.classList.add('d-none');
    }
}

function renderNotifications(notifications) {
    const list = document.getElementById('notificationList');
    
    if (notifications.length === 0) {
        list.innerHTML = `
            <div class="notification-empty">
                <i class="fas fa-bell-slash fa-2x mb-3"></i>
                <p>Yeni bildirim yok</p>
            </div>`;
        document.getElementById('markAllBtn').style.display = 'none';
        return;
    }
    
    list.innerHTML = notifications.map(n => `
        <div class="notification-item unread" onclick="openNotification(${n.id}, '${n.url || ''}')" data-id="${n.id}">
            <div class="notification-icon ${n.type}">
                <i class="fas ${n.typeIcon}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${escapeHtml(n.title)}</div>
                <div class="notification-message">${escapeHtml(n.message)}</div>
                <div class="notification-time">${n.timeAgo}</div>
            </div>
        </div>
    `).join('');
}

async function openNotification(id, url) {
    try {
        await fetch(`/api/Notification/read/${id}`, { method: 'POST' });
        
        // Update UI
        const item = document.querySelector(`.notification-item[data-id="${id}"]`);
        if (item) item.classList.remove('unread');
        
        // Update badge
        const badge = document.getElementById('notificationBadge');
        let count = parseInt(badge.textContent) || 0;
        if (count > 0) {
            updateNotificationBadge(count - 1);
        }
        
        // Navigate if URL exists
        if (url) {
            window.location.href = url;
        }
    } catch (error) {
        console.error('Failed to mark as read:', error);
    }
}

async function markAllAsRead() {
    try {
        await fetch('/api/Notification/read-all', { method: 'POST' });
        
        // Update UI
        document.querySelectorAll('.notification-item.unread').forEach(item => {
            item.classList.remove('unread');
        });
        
        updateNotificationBadge(0);
    } catch (error) {
        console.error('Failed to mark all as read:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load notification count on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/Notification/count');
        const data = await response.json();
        if (data.success) {
            updateNotificationBadge(data.count);
        }
    } catch (error) {
        console.error('Failed to get notification count:', error);
    }
});

// SignalR connection (if available)
if (typeof signalR !== 'undefined') {
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/notificationHub")
        .withAutomaticReconnect()
        .build();
    
    connection.on("ReceiveNotification", function(notification) {
        // Show toast notification
        showToast(notification.title, notification.message);
        
        // Update badge
        const badge = document.getElementById('notificationBadge');
        let count = parseInt(badge.textContent) || 0;
        updateNotificationBadge(count + 1);
        
        // Reset loaded state to refresh list
        notificationLoaded = false;
    });
    
    connection.start().catch(err => console.error('SignalR Error:', err));
}

function showToast(title, message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'notification-toast';
    toast.innerHTML = `
        <div class="toast-header">
            <i class="fas fa-bell text-primary me-2"></i>
            <strong>${escapeHtml(title)}</strong>
            <button type="button" onclick="this.closest('.notification-toast').remove()">×</button>
        </div>
        <div class="toast-body">${escapeHtml(message)}</div>
    `;
    
    // Add styles if not exists
    if (!document.getElementById('toast-styles')) {
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
            .notification-toast {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 320px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            }
            .notification-toast .toast-header {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                border-bottom: 1px solid #e5e7eb;
            }
            .notification-toast .toast-header strong { flex: 1; }
            .notification-toast .toast-header button {
                background: none;
                border: none;
                font-size: 20px;
                color: #666;
                cursor: pointer;
            }
            .notification-toast .toast-body {
                padding: 12px 16px;
                font-size: 14px;
                color: #666;
            }
            @@keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => toast.remove(), 5000);
}
</script>
