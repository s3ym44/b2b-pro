@model B2BProcurement.Controllers.QuotationFormViewModel
@{
    ViewData["Title"] = "Teklif Hazırla";
    ViewData["PageTitle"] = "Teklif Hazırla";
    ViewData["Breadcrumb"] = "Teklif";
}

@section Styles {
<link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
<style>
    /* RFQ Summary Card */
    .rfq-summary {
        background: linear-gradient(135deg, #1E293B, #334155);
        border-radius: var(--radius-lg);
        padding: 24px 32px;
        color: white;
        margin-bottom: 24px;
    }
    
    .rfq-summary-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    
    .rfq-summary-title h4 {
        margin: 0 0 4px;
        font-weight: 700;
    }
    
    .rfq-summary-title p {
        margin: 0;
        opacity: 0.7;
        font-size: 14px;
    }
    
    .rfq-deadline {
        background: rgba(255,255,255,0.1);
        padding: 12px 20px;
        border-radius: var(--radius-md);
        text-align: center;
    }
    
    .rfq-deadline-value {
        font-size: 20px;
        font-weight: 700;
    }
    
    .rfq-deadline-label {
        font-size: 12px;
        opacity: 0.7;
    }
    
    .rfq-meta-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }
    
    .rfq-meta-item {
        background: rgba(255,255,255,0.05);
        padding: 12px 16px;
        border-radius: var(--radius-md);
    }
    
    .rfq-meta-label {
        font-size: 11px;
        opacity: 0.7;
        text-transform: uppercase;
    }
    
    .rfq-meta-value {
        font-weight: 600;
        font-size: 15px;
    }
    
    /* Section Card */
    .section-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .section-header {
        padding: 20px 24px;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .section-header h5 {
        margin: 0;
        font-weight: 600;
        color: var(--gray-800);
    }
    
    .section-header .badge {
        background: var(--primary);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
    }
    
    .section-body {
        padding: 24px;
    }
    
    /* Items Table */
    .items-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .items-table th {
        background: var(--gray-50);
        padding: 14px 16px;
        font-size: 12px;
        font-weight: 600;
        color: var(--gray-600);
        text-transform: uppercase;
        text-align: left;
        border-bottom: 2px solid var(--gray-200);
    }
    
    .items-table td {
        padding: 16px;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: top;
    }
    
    .items-table tr:hover {
        background: var(--gray-50);
    }
    
    .item-info h6 {
        margin: 0 0 4px;
        font-weight: 600;
        color: var(--gray-800);
    }
    
    .item-info .specs {
        font-size: 13px;
        color: var(--gray-500);
        margin-bottom: 8px;
    }
    
    .item-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--primary);
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    /* Input Group */
    .price-input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .price-input-group label {
        font-size: 11px;
        font-weight: 600;
        color: var(--gray-500);
        text-transform: uppercase;
    }
    
    .price-input-group input {
        padding: 10px 14px;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        min-width: 100px;
    }
    
    .price-input-group input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    /* Calculated Total */
    .item-total {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary);
        text-align: right;
    }
    
    .item-total-label {
        font-size: 11px;
        color: var(--gray-500);
        text-transform: uppercase;
    }
    
    /* Summary Footer */
    .items-summary {
        background: var(--gray-800);
        color: white;
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .summary-label {
        font-size: 14px;
        opacity: 0.7;
    }
    
    .summary-total {
        font-size: 28px;
        font-weight: 700;
    }
    
    /* Form Section */
    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 8px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    /* Dropzone */
    .dropzone-container {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-md);
        padding: 30px;
        text-align: center;
        background: var(--gray-50);
        cursor: pointer;
    }
    
    .dropzone-container:hover {
        border-color: var(--primary);
    }
    
    .dropzone-icon {
        font-size: 40px;
        color: var(--gray-400);
        margin-bottom: 12px;
    }
    
    /* Action Buttons */
    .action-bar {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .btn-action {
        padding: 14px 28px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 15px;
    }
    
    .action-buttons {
        display: flex;
        gap: 12px;
    }
    
    .btn-draft {
        background: var(--gray-600);
        color: white;
        border: none;
    }
    
    .btn-draft:hover {
        background: var(--gray-700);
        color: white;
    }
    
    .btn-submit {
        background: var(--success);
        color: white;
        border: none;
    }
    
    .btn-submit:hover {
        background: #059669;
        color: white;
    }
    
    /* Checkbox */
    .form-check-label {
        font-size: 14px;
        color: var(--gray-700);
    }
</style>
}

<!-- Back Button -->
<div class="mb-4">
    <a href="@Url.Action("Incoming", "Rfq")" class="btn btn-light">
        <i class="fas fa-arrow-left me-2"></i>Gelen RFQ'lara Dön
    </a>
</div>

<!-- RFQ Summary -->
<div class="rfq-summary">
    <div class="rfq-summary-header">
        <div class="rfq-summary-title">
            <h4><i class="fas fa-file-invoice me-2"></i>@Model.RfqTitle</h4>
            <p>@Model.RfqNumber | Para Birimi: @Model.Currency</p>
        </div>
        @if (Model.RfqEndDate.HasValue)
        {
            var daysLeft = (Model.RfqEndDate.Value - DateTime.Now).Days;
            <div class="rfq-deadline">
                <div class="rfq-deadline-value">@daysLeft gün</div>
                <div class="rfq-deadline-label">Kalan Süre</div>
            </div>
        }
    </div>
    <div class="rfq-meta-row">
        <div class="rfq-meta-item">
            <div class="rfq-meta-label">Kalem Sayısı</div>
            <div class="rfq-meta-value">@Model.RfqItems.Count</div>
        </div>
        <div class="rfq-meta-item">
            <div class="rfq-meta-label">Son Teklif Tarihi</div>
            <div class="rfq-meta-value">@Model.RfqEndDate?.ToString("dd.MM.yyyy")</div>
        </div>
        <div class="rfq-meta-item">
            <div class="rfq-meta-label">Para Birimi</div>
            <div class="rfq-meta-value">@Model.Currency</div>
        </div>
        <div class="rfq-meta-item">
            <div class="rfq-meta-label">RFQ ID</div>
            <div class="rfq-meta-value">#@Model.RfqId</div>
        </div>
    </div>
</div>

<form asp-action="Create" method="post" id="quotationForm" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="RfqId" />
    <input type="hidden" name="ItemsJson" id="itemsJsonInput" />
    
    <!-- Items Section -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-list-ul text-primary"></i>
            <h5>Teklif Kalemleri</h5>
            <span class="badge">@Model.RfqItems.Count Kalem</span>
        </div>
        <div class="section-body p-0">
            <table class="items-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Kalem Bilgisi</th>
                        <th>Miktar</th>
                        <th>Birim Fiyat (@Model.Currency)</th>
                        <th>Teslim Tarihi</th>
                        <th style="text-align: right;">Toplam</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    @foreach (var item in Model.RfqItems)
                    {
                        <tr data-item-id="@item.RfqItemId">
                            <td>
                                <div class="item-info">
                                    <h6>@item.Description</h6>
                                    @if (!string.IsNullOrEmpty(item.MaterialName))
                                    {
                                        <div class="specs"><i class="fas fa-box me-1"></i>@item.MaterialName</div>
                                    }
                                    @if (!string.IsNullOrEmpty(item.TechnicalSpecs))
                                    {
                                        <div class="specs"><i class="fas fa-cog me-1"></i>@item.TechnicalSpecs</div>
                                    }
                                    <span class="item-badge">
                                        <i class="fas fa-cube"></i>@item.RequestedQuantity.ToString("N2") @item.Unit
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="price-input-group">
                                    <label>Teklif Miktarı</label>
                                    <input type="number" class="item-quantity" 
                                           data-item-id="@item.RfqItemId"
                                           value="@item.RequestedQuantity"
                                           step="0.01" min="0.01"
                                           onchange="calculateItemTotal(@item.RfqItemId)" />
                                </div>
                            </td>
                            <td>
                                <div class="price-input-group">
                                    <label>Birim Fiyat</label>
                                    <input type="number" class="item-price"
                                           data-item-id="@item.RfqItemId"
                                           placeholder="0.00"
                                           step="0.01" min="0"
                                           onchange="calculateItemTotal(@item.RfqItemId)" />
                                </div>
                            </td>
                            <td>
                                <div class="price-input-group">
                                    <label>Teslim Tarihi</label>
                                    <input type="date" class="item-delivery"
                                           data-item-id="@item.RfqItemId" />
                                </div>
                            </td>
                            <td>
                                <div class="item-total-label">TOPLAM</div>
                                <div class="item-total" id="itemTotal-@item.RfqItemId">0.00</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="items-summary">
            <div>
                <div class="summary-label">Toplam Kalem: @Model.RfqItems.Count</div>
            </div>
            <div>
                <div class="summary-label">GENEL TOPLAM</div>
                <div class="summary-total" id="grandTotal">0.00 <small>@Model.Currency</small></div>
            </div>
        </div>
    </div>
    
    <!-- General Info Section -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-info-circle text-primary"></i>
            <h5>Genel Bilgiler</h5>
        </div>
        <div class="section-body">
            <div class="form-row">
                <div class="form-group">
                    <label><i class="fas fa-calendar me-2"></i>Teklif Geçerlilik Tarihi</label>
                    <input type="date" asp-for="ValidUntil" class="form-control" />
                    <small class="text-muted">Teklifinizin geçerli olacağı son tarih</small>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-truck me-2"></i>Teslimat Şartları</label>
                    <select name="DeliveryTerms" class="form-select">
                        <option value="">Seçin...</option>
                        <option value="EXW">EXW - Fabrikada Teslim</option>
                        <option value="FOB">FOB - Gemi Bordasında</option>
                        <option value="CIF">CIF - Mal Bedeli, Sigorta ve Navlun</option>
                        <option value="DAP">DAP - Belirlenen Yerde Teslim</option>
                        <option value="DDP">DDP - Gümrük Vergileri Ödenmiş</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label><i class="fas fa-credit-card me-2"></i>Ödeme Şartları</label>
                    <select name="PaymentTerms" class="form-select">
                        <option value="">Seçin...</option>
                        <option value="Pesin">Peşin</option>
                        <option value="30Gun">30 Gün Vadeli</option>
                        <option value="60Gun">60 Gün Vadeli</option>
                        <option value="90Gun">90 Gün Vadeli</option>
                        <option value="Diger">Diğer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-percentage me-2"></i>KDV Durumu</label>
                    <select name="VatStatus" class="form-select">
                        <option value="Dahil">KDV Dahil</option>
                        <option value="Haric">KDV Hariç</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label><i class="fas fa-comment me-2"></i>Teknik Uyum Açıklaması</label>
                <textarea name="TechnicalNotes" class="form-control" rows="3" 
                    placeholder="Talep edilen teknik özelliklere uyum durumunuzu açıklayın..."></textarea>
            </div>
            <div class="form-group mb-0">
                <label><i class="fas fa-sticky-note me-2"></i>Genel Notlar</label>
                <textarea name="Notes" class="form-control" rows="3"
                    placeholder="Ek açıklamalar, özel koşullar vb..."></textarea>
            </div>
        </div>
    </div>
    
    <!-- Documents Section -->
    <div class="section-card">
        <div class="section-header">
            <i class="fas fa-file-upload text-primary"></i>
            <h5>Dokümanlar</h5>
        </div>
        <div class="section-body">
            <div class="dropzone-container" id="documentDropzone">
                <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
                <h6>Dosya Ekle</h6>
                <p class="text-muted mb-0">Fiyat teklifi, teknik dokümanlar, sertifikalar vb.</p>
                <small class="text-muted">PDF, Word, Excel, Görsel (Max: 10MB)</small>
            </div>
            <div id="uploadedFilesList" class="mt-3"></div>
        </div>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
        <div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="submitNow" name="SubmitNow" value="true" />
                <label class="form-check-label" for="submitNow">
                    <strong>Hemen Gönder</strong> - İşaretlenmezse taslak olarak kaydedilir
                </label>
            </div>
        </div>
        <div class="action-buttons">
            <a href="@Url.Action("Incoming", "Rfq")" class="btn btn-action btn-light">
                <i class="fas fa-times me-2"></i>İptal
            </a>
            <button type="submit" class="btn btn-action btn-draft" id="btnSave">
                <i class="fas fa-save me-2"></i>Kaydet
            </button>
        </div>
    </div>
</form>

@section Scripts {
<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
<script>
    // ===== ITEM CALCULATIONS =====
    function calculateItemTotal(itemId) {
        const quantityInput = document.querySelector(`.item-quantity[data-item-id="${itemId}"]`);
        const priceInput = document.querySelector(`.item-price[data-item-id="${itemId}"]`);
        const totalEl = document.getElementById(`itemTotal-${itemId}`);
        
        const quantity = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = quantity * price;
        
        totalEl.textContent = total.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        calculateGrandTotal();
    }
    
    function calculateGrandTotal() {
        let grandTotal = 0;
        document.querySelectorAll('.items-table tbody tr').forEach(row => {
            const itemId = row.dataset.itemId;
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            grandTotal += quantity * price;
        });
        
        document.getElementById('grandTotal').innerHTML = 
            grandTotal.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 
            ' <small>@Model.Currency</small>';
    }
    
    // ===== FORM SUBMISSION =====
    document.getElementById('quotationForm').addEventListener('submit', function(e) {
        const items = [];
        let hasValidItem = false;
        
        document.querySelectorAll('.items-table tbody tr').forEach(row => {
            const itemId = parseInt(row.dataset.itemId);
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const deliveryEl = row.querySelector('.item-delivery');
            const delivery = deliveryEl.value || null;
            
            if (price > 0) {
                hasValidItem = true;
                items.push({
                    RfqItemId: itemId,
                    OfferedQuantity: quantity,
                    UnitPrice: price,
                    DeliveryDate: delivery
                });
            }
        });
        
        if (!hasValidItem) {
            e.preventDefault();
            alert('En az bir kalem için fiyat girmelisiniz.');
            return false;
        }
        
        document.getElementById('itemsJsonInput').value = JSON.stringify(items);
    });
    
    // ===== SUBMIT NOW CHECKBOX =====
    document.getElementById('submitNow').addEventListener('change', function() {
        const btn = document.getElementById('btnSave');
        if (this.checked) {
            btn.className = 'btn btn-action btn-submit';
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Gönder';
        } else {
            btn.className = 'btn btn-action btn-draft';
            btn.innerHTML = '<i class="fas fa-save me-2"></i>Kaydet';
        }
    });
    
    // ===== DROPZONE =====
    Dropzone.autoDiscover = false;
    let uploadedFiles = [];
    
    $(document).ready(function() {
        new Dropzone("#documentDropzone", {
            url: "/Quotation/UploadTemp",
            autoProcessQueue: false,
            addRemoveLinks: true,
            maxFilesize: 10,
            acceptedFiles: ".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png",
            dictDefaultMessage: "",
            init: function() {
                this.on("addedfile", file => { uploadedFiles.push(file); renderFiles(); });
                this.on("removedfile", file => { uploadedFiles = uploadedFiles.filter(f => f !== file); renderFiles(); });
            }
        });
    });
    
    function renderFiles() {
        const container = $('#uploadedFilesList');
        container.empty();
        uploadedFiles.forEach((file, i) => {
            const size = (file.size / 1024).toFixed(1) + ' KB';
            container.append(`
                <div class="d-flex align-items-center gap-3 p-2 bg-light rounded mb-2">
                    <i class="fas fa-file text-muted"></i>
                    <div class="flex-grow-1">
                        <div class="fw-medium">${file.name}</div>
                        <small class="text-muted">${size}</small>
                    </div>
                </div>
            `);
        });
    }
</script>
}
