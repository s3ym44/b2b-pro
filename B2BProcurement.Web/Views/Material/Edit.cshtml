@model B2BProcurement.Controllers.MaterialFormViewModel
@{
    var isEdit = Model.Id > 0;
    ViewData["Title"] = isEdit ? "Malzeme Düzenle" : "Yeni Malzeme";
    ViewData["PageTitle"] = isEdit ? "Malzeme Düzenle" : "Yeni Malzeme";
    ViewData["Breadcrumb"] = "Malzemeler";
}

@section Styles {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/min/dropzone.min.css">
<style>
    .form-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
    }
    
    .form-header {
        padding: 24px;
        border-bottom: 1px solid var(--gray-100);
    }
    
    .form-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    .form-body {
        padding: 24px;
    }
    
    .form-section {
        margin-bottom: 32px;
    }
    
    .form-section:last-child {
        margin-bottom: 0;
    }
    
    .form-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--gray-100);
    }
    
    .form-label {
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 6px;
    }
    
    .form-label .required {
        color: var(--danger);
    }
    
    .form-control, .form-select {
        border-radius: var(--radius-md);
        border-color: var(--gray-200);
        padding: 10px 14px;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(123, 47, 247, 0.1);
    }
    
    .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
    
    .form-footer {
        padding: 20px 24px;
        background: var(--gray-50);
        border-top: 1px solid var(--gray-100);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    /* Dropzone Styling */
    .dropzone {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-lg);
        background: var(--gray-50);
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-fast);
    }
    
    .dropzone:hover {
        border-color: var(--primary);
        background: rgba(123, 47, 247, 0.02);
    }
    
    .dropzone.dz-drag-hover {
        border-color: var(--primary);
        background: rgba(123, 47, 247, 0.05);
    }
    
    .dropzone .dz-message {
        text-align: center;
        margin: 0;
    }
    
    .dropzone .dz-message .upload-icon {
        font-size: 48px;
        color: var(--gray-400);
        margin-bottom: 16px;
    }
    
    .dropzone .dz-message h5 {
        font-size: 16px;
        color: var(--gray-700);
        margin-bottom: 8px;
    }
    
    .dropzone .dz-message p {
        font-size: 13px;
        color: var(--gray-500);
        margin: 0;
    }
    
    .existing-docs {
        margin-top: 16px;
    }
    
    .doc-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--gray-50);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
    }
    
    .doc-item:last-child {
        margin-bottom: 0;
    }
    
    .doc-icon {
        width: 40px;
        height: 40px;
        background: var(--white);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: var(--primary);
    }
    
    .doc-icon.image {
        overflow: hidden;
        padding: 0;
    }
    
    .doc-icon.image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .doc-info {
        flex: 1;
    }
    
    .doc-name {
        font-weight: 500;
        color: var(--gray-800);
        font-size: 14px;
    }
    
    .doc-size {
        font-size: 12px;
        color: var(--gray-500);
    }
    
    .doc-actions .btn {
        padding: 6px 10px;
    }
</style>
}

<div class="row justify-content-center">
    <div class="col-xl-8 col-lg-10">
        <div class="form-card">
            <div class="form-header">
                <h5><i class="fas fa-@(isEdit ? "edit" : "plus") me-2"></i>@ViewData["Title"]</h5>
            </div>
            
            <form asp-action="@(isEdit ? "Edit" : "Create")" method="post" enctype="multipart/form-data" id="materialForm">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="Id" />
                
                <div class="form-body">
                    <!-- Temel Bilgiler -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-info-circle me-2"></i>Temel Bilgiler
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="Code" class="form-label">
                                    Malzeme Kodu <span class="required">*</span>
                                </label>
                                <input asp-for="Code" class="form-control" placeholder="Örn: MLZ-001" />
                                <span asp-validation-for="Code" class="text-danger small"></span>
                            </div>
                            <div class="col-md-8">
                                <label asp-for="Name" class="form-label">
                                    Malzeme Adı <span class="required">*</span>
                                </label>
                                <input asp-for="Name" class="form-control" placeholder="Malzeme adını girin" />
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>
                            <div class="col-12">
                                <label asp-for="Description" class="form-label">
                                    Açıklama
                                </label>
                                <textarea asp-for="Description" class="form-control" rows="3" 
                                          placeholder="Malzeme hakkında detaylı bilgi..."></textarea>
                                <span asp-validation-for="Description" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kategorizasyon -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-tags me-2"></i>Kategorizasyon
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="SectorId" class="form-label">
                                    Sektör <span class="required">*</span>
                                </label>
                                <select asp-for="SectorId" class="form-select" asp-items="@ViewBag.Sectors">
                                    <option value="">Sektör seçin...</option>
                                </select>
                                <span asp-validation-for="SectorId" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Unit" class="form-label">
                                    Birim <span class="required">*</span>
                                </label>
                                <select asp-for="Unit" class="form-select" asp-items="@ViewBag.Units">
                                    <option value="">Birim seçin...</option>
                                </select>
                                <span asp-validation-for="Unit" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ayarlar -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-cog me-2"></i>Ayarlar
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input asp-for="IsPublic" class="form-check-input" />
                                    <label asp-for="IsPublic" class="form-check-label">
                                        Herkese açık (Diğer şirketler görebilir)
                                    </label>
                                </div>
                            </div>
                            @if (isEdit)
                            {
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input asp-for="IsActive" class="form-check-input" />
                                        <label asp-for="IsActive" class="form-check-label">
                                            Aktif
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <!-- Dokümanlar -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-paperclip me-2"></i>Dokümanlar
                        </div>
                        
                        <div id="documentDropzone" class="dropzone">
                            <div class="dz-message">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h5>Dosyaları sürükleyip bırakın</h5>
                                <p>veya <strong>tıklayarak seçin</strong></p>
                                <p class="mt-2 text-muted">PDF, Word, Excel, Resim (Max 10MB)</p>
                            </div>
                        </div>
                        
                        <!-- Mevcut Dokümanlar -->
                        @if (Model.ExistingDocuments.Any())
                        {
                            <div class="existing-docs">
                                <h6 class="mb-3">Mevcut Dokümanlar</h6>
                                @foreach (var doc in Model.ExistingDocuments)
                                {
                                    <div class="doc-item" id="doc-@doc.Id">
                                        @if (doc.IsImage)
                                        {
                                            <div class="doc-icon image">
                                                <img src="@doc.FilePath" alt="@doc.FileName" />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="doc-icon">
                                                <i class="fas fa-file"></i>
                                            </div>
                                        }
                                        <div class="doc-info">
                                            <div class="doc-name">@doc.FileName</div>
                                            <div class="doc-size">@doc.FormattedSize</div>
                                        </div>
                                        <div class="doc-actions">
                                            <a href="@doc.FilePath" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteDocument(@doc.Id)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
                
                <div class="form-footer">
                    <a href="@Url.Action("Index")" class="btn btn-light">
                        <i class="fas fa-times me-2"></i>İptal
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>@(isEdit ? "Güncelle" : "Kaydet")
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/min/dropzone.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>
<script>
    Dropzone.autoDiscover = false;
    
    // Dropzone configuration
    const myDropzone = new Dropzone("#documentDropzone", {
        url: "@Url.Action("UploadDocument")",
        autoProcessQueue: false,
        uploadMultiple: true,
        parallelUploads: 5,
        maxFiles: 10,
        maxFilesize: 10, // MB
        acceptedFiles: ".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif",
        addRemoveLinks: true,
        dictRemoveFile: "Kaldır",
        dictCancelUpload: "İptal",
        headers: {
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        },
        init: function() {
            const dropzone = this;
            
            // Form submit handling
            document.getElementById('materialForm').addEventListener('submit', function(e) {
                if (dropzone.getQueuedFiles().length > 0) {
                    e.preventDefault();
                    
                    // First submit form via AJAX, then upload files
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    });
                }
            });
        }
    });
    
    // Add files to form before submit
    document.getElementById('materialForm').addEventListener('submit', function(e) {
        const files = myDropzone.getAcceptedFiles();
        const dataTransfer = new DataTransfer();
        
        files.forEach(file => {
            dataTransfer.items.add(file);
        });
        
        // Create hidden file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.name = 'Documents';
        fileInput.multiple = true;
        fileInput.files = dataTransfer.files;
        fileInput.style.display = 'none';
        this.appendChild(fileInput);
    });
    
    // Delete existing document
    function deleteDocument(docId) {
        if (!confirm('Bu dokümanı silmek istediğinizden emin misiniz?')) return;
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        fetch('@Url.Action("DeleteDocument")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': token
            },
            body: 'documentId=' + docId + '&__RequestVerificationToken=' + token
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('doc-' + docId).remove();
            } else {
                alert(data.message);
            }
        });
    }
</script>
}
